<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ---------- إعداد Supabase ----------
const SUPABASE_URL = "https://ztwbgqkxmdhpzqhnefty.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0d2JncWt4bWRocHpxaG5lZnR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMTQwMDEsImV4cCI6MjA3OTU5MDAwMX0.6W_V9v5VxQpPfv65Ygc51-m7G1Z8sl8fx1B8bWyA6Xg";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- تحميل الأقسام + المنتجات ---
async function loadMenu() {

    const { data: categories, error: catError } = await supabaseClient
        .from("categories")
        .select("*")
        .order("id");

    if (catError) {
        console.error("خطأ جلب الأقسام:", catError);
        return;
    }

    const { data: products, error: prodError } = await supabaseClient
        .from("products")
        .select("*")
        .order("id");

    if (prodError) {
        console.error("خطأ جلب المنتجات:", prodError);
        return;
    }

    renderSections(categories);
    renderProducts(categories, products);
}

// --- الأقسام ---
function renderSections(categories) {
    const secDiv = document.getElementById("sections");
    secDiv.innerHTML = "";

    secDiv.innerHTML += `
        <button class="section-btn active" data-section="all">الكل</button>
    `;

    categories.forEach(cat => {
        secDiv.innerHTML += `
            <button class="section-btn" data-section="${cat.id}">${cat.name}</button>
        `;
    });

    document.querySelectorAll(".section-btn").forEach(btn => {
        btn.onclick = () => {
            document.querySelector(".section-btn.active")?.classList.remove("active");
            btn.classList.add("active");
            renderSelected(btn.dataset.section);
        };
    });
}

let globalProducts = [];
let globalCategories = [];

function renderProducts(categories, products) {
    globalProducts = products;
    globalCategories = categories;
    renderSelected("all");
}

// --- عرض المنتجات ---
function renderSelected(section) {
    const mealsDiv = document.getElementById("meals");
    mealsDiv.innerHTML = "";

    let shown = section === "all"
        ? globalProducts
        : globalProducts.filter(p => p.category_id == section);

    shown.forEach(p => {
        mealsDiv.innerHTML += `
            <div class="meal">
                <div class="img">
                    <img src="${p.image_url || ""}">
                </div>
                <div class="info">
                    <h3>${p.name}</h3>
                    <p>${p.description || ""}</p>
                    <div class="price">${p.price} ر.س</div>
                    <button class="add-to-cart" data-name="${p.name}" data-price="${p.price}">
                        إضافة للسلة
                    </button>
                </div>
            </div>
        `;
    });
}

// --- تحميل القائمة بعد فتح الصفحة ---
document.addEventListener("DOMContentLoaded", loadMenu);
</script>